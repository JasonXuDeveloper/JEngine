name: Unity Tests (Reusable)

on:
  workflow_call:
    inputs:
      unity_version:
        description: 'Unity version (leave empty to use .github/unity-config.env)'
        required: false
        type: string
        default: ''
      test_mode:
        description: 'Test mode to run (All, EditMode, PlayMode)'
        required: false
        type: string
        default: 'All'
      project_path:
        description: 'Path to Unity project (leave empty to use .github/unity-config.env)'
        required: false
        type: string
        default: ''
    outputs:
      test_results:
        description: 'Test results summary'
        value: ${{ jobs.test.outputs.results }}

permissions:
  contents: read
  checks: write

jobs:
  test:
    name: Run Unity Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write
    outputs:
      results: ${{ steps.test-summary.outputs.summary }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      # Load centralized Unity configuration
      - name: Load Unity config
        id: config
        run: |
          source .github/unity-config.env
          # Use input if provided, otherwise use config file value
          if [ -n "${{ inputs.unity_version }}" ]; then
            echo "version=${{ inputs.unity_version }}" >> $GITHUB_OUTPUT
          else
            echo "version=$UNITY_VERSION" >> $GITHUB_OUTPUT
          fi
          if [ -n "${{ inputs.project_path }}" ]; then
            echo "project_path=${{ inputs.project_path }}" >> $GITHUB_OUTPUT
          else
            echo "project_path=$UNITY_PROJECT_PATH" >> $GITHUB_OUTPUT
          fi

      - name: Cache Unity Library
        uses: actions/cache@v4
        with:
          path: ${{ steps.config.outputs.project_path }}/Library
          key: Library-${{ steps.config.outputs.project_path }}-${{ steps.config.outputs.version }}-${{ hashFiles(format('{0}/Packages/packages-lock.json', steps.config.outputs.project_path)) }}
          restore-keys: |
            Library-${{ steps.config.outputs.project_path }}-${{ steps.config.outputs.version }}-
            Library-${{ steps.config.outputs.project_path }}-

      - name: Run EditMode tests
        if: inputs.test_mode == 'All' || inputs.test_mode == 'EditMode'
        uses: game-ci/unity-test-runner@v4
        id: editmode-tests
        env:
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
          UNITY_SERIAL: ${{ secrets.UNITY_SERIAL }}
        with:
          projectPath: ${{ steps.config.outputs.project_path }}
          unityVersion: ${{ steps.config.outputs.version }}
          testMode: EditMode
          artifactsPath: artifacts/EditMode
          githubToken: ${{ secrets.GITHUB_TOKEN }}
          checkName: EditMode Test Results

      - name: Run PlayMode tests
        if: inputs.test_mode == 'All' || inputs.test_mode == 'PlayMode'
        uses: game-ci/unity-test-runner@v4
        id: playmode-tests
        env:
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
          UNITY_SERIAL: ${{ secrets.UNITY_SERIAL }}
        with:
          projectPath: ${{ steps.config.outputs.project_path }}
          unityVersion: ${{ steps.config.outputs.version }}
          testMode: PlayMode
          artifactsPath: artifacts/PlayMode
          githubToken: ${{ secrets.GITHUB_TOKEN }}
          checkName: PlayMode Test Results

      - name: Upload EditMode test results
        if: always() && (inputs.test_mode == 'All' || inputs.test_mode == 'EditMode')
        uses: actions/upload-artifact@v4
        with:
          name: EditMode-results-${{ steps.config.outputs.version }}
          path: artifacts/EditMode
          if-no-files-found: warn
          retention-days: 14

      - name: Upload PlayMode test results
        if: always() && (inputs.test_mode == 'All' || inputs.test_mode == 'PlayMode')
        uses: actions/upload-artifact@v4
        with:
          name: PlayMode-results-${{ steps.config.outputs.version }}
          path: artifacts/PlayMode
          if-no-files-found: warn
          retention-days: 14

      - name: Generate test summary
        id: test-summary
        if: always()
        run: |
          SUMMARY="## Unity Test Results\n\n"

          if [ "${{ inputs.test_mode }}" == "All" ] || [ "${{ inputs.test_mode }}" == "EditMode" ]; then
            EDITMODE_RESULT="${{ steps.editmode-tests.outcome }}"
            if [ "$EDITMODE_RESULT" == "success" ]; then
              SUMMARY="${SUMMARY}✅ **EditMode**: All tests passed\n"
            else
              SUMMARY="${SUMMARY}❌ **EditMode**: Tests failed\n"
            fi
          fi

          if [ "${{ inputs.test_mode }}" == "All" ] || [ "${{ inputs.test_mode }}" == "PlayMode" ]; then
            PLAYMODE_RESULT="${{ steps.playmode-tests.outcome }}"
            if [ "$PLAYMODE_RESULT" == "success" ]; then
              SUMMARY="${SUMMARY}✅ **PlayMode**: All tests passed\n"
            else
              SUMMARY="${SUMMARY}❌ **PlayMode**: Tests failed\n"
            fi
          fi

          SUMMARY="${SUMMARY}\n**Unity Version**: ${{ steps.config.outputs.version }}\n"
          SUMMARY="${SUMMARY}**Project Path**: ${{ steps.config.outputs.project_path }}"

          echo "summary<<EOF" >> $GITHUB_OUTPUT
          echo -e "$SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Return Unity license
        uses: game-ci/unity-return-license@v2
        if: always()
