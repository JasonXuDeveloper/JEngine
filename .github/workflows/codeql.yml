name: CodeQL Security Analysis

on:
  push:
    branches: [master]
    paths:
      - 'UnityProject/Packages/com.jasonxudeveloper.jengine.core/**'
      - 'UnityProject/Packages/com.jasonxudeveloper.jengine.util/**'
      - 'UnityProject/Assets/HotUpdate/Code/**'
      - '.github/codeql/**'
      - '.github/workflows/codeql.yml'
  pull_request:
    branches: [master]
    paths:
      - 'UnityProject/Packages/com.jasonxudeveloper.jengine.core/**'
      - 'UnityProject/Packages/com.jasonxudeveloper.jengine.util/**'
      - 'UnityProject/Assets/HotUpdate/Code/**'
      - '.github/codeql/**'
      - '.github/workflows/codeql.yml'
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch:

jobs:
  analyze:
    name: Analyze C# Code
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      # Load centralized Unity configuration
      - name: Load Unity config
        id: unity-config
        run: |
          source .github/unity-config.env
          echo "version=$UNITY_VERSION" >> $GITHUB_OUTPUT
          echo "project_path=$UNITY_PROJECT_PATH" >> $GITHUB_OUTPUT
          echo "target_platform=$UNITY_TARGET_PLATFORM" >> $GITHUB_OUTPUT

      - name: Cache Unity Library
        uses: actions/cache@v4
        with:
          path: ${{ steps.unity-config.outputs.project_path }}/Library
          key: Library-CodeQL-${{ steps.unity-config.outputs.version }}-${{ hashFiles(format('{0}/Packages/packages-lock.json', steps.unity-config.outputs.project_path)) }}
          restore-keys: |
            Library-CodeQL-${{ steps.unity-config.outputs.version }}-
            Library-CodeQL-

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: csharp
          config-file: ./.github/codeql/codeql-config.yml
          queries: security-and-quality
          build-mode: manual

      - name: Compile Unity Scripts
        uses: game-ci/unity-builder@v4
        env:
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
          UNITY_SERIAL: ${{ secrets.UNITY_SERIAL }}
        with:
          projectPath: ${{ steps.unity-config.outputs.project_path }}
          unityVersion: ${{ steps.unity-config.outputs.version }}
          targetPlatform: ${{ steps.unity-config.outputs.target_platform }}
          buildName: CodeQL
          customParameters: -nographics -quit

      - name: Return Unity license
        uses: game-ci/unity-return-license@v2
        if: always()

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:csharp"
